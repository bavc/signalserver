{% extends 'base.html' %}
{% block content %}
<style>
#div1 {width:500px;height:200px;padding:10px;border:1px solid #aaaaaa;}
</style>


<span>
    <div class = "container-fluid">
    <h1> Add/Update/Delete Rules on Policies </h1>
    <div class="row">
    <div class="col-md-9">
    <h3>Policy Name: {{ policy.policy_name }} </h3>
        <h4>Show in dashboard: {{policy.dashboard }} </h4>
        <p> ** If the result value is exceeded higer or lower above or below from average results among the group, the filename is reported in summary or/and dashboard</p>
    {% if error_message %}<p><strong>{{ error_message }}</strong></p>{% endif %}
    {% for choice in operation %}
    <p>
        <label for="choice{{ forloop.counter }}">
            <ul>
            {% if choice.get_second_signal_name_display != "None" %}
                Average difference beween "{{ choice.get_signal_name_display }}" and "{{ choice.get_second_signal_name_display }}"
            {% elif choice.get_op_name_display == "exceeds"  %}
                {{ choice.get_signal_name_display }} count of the frames with value above {{ choice.cut_off_number }}
            {% elif choice.get_op_name_display == "belows"  %}
                {{ choice.get_signal_name_display }} count of the frame with value below {{ choice.cut_off_number }}
            {% elif choice.get_op_name_display == "equals"  %}
                {{ choice.get_signal_name_display }} count of the frame with value euqal to {{ choice.cut_off_number }}
            {% else %}
                Average of  {{ choice.get_signal_name_display }}
            {% endif %}
            </ul>
            <ul>
            Description:  {{ choice.description }}
            </ul>
            <ul>
            Percentage for the reporting** : {{ choice.percentage }} %
            </ul>
            <ul>
            Report in dashboard : {{choice.dashboard}}
            </ul>
            <div id = "edit_form{{ forloop.counter }}">
            <form id="form_edit" action="{% url 'policies:show' policy.id %}" name = "edit" method="post" class="form">
                {% csrf_token %}
                <div id="policy_edit{{ forloop.counter }}">
                <!-- variable -->
                    <input name='action' type="hidden" value="edit">
                    <input name='id_num' type="hidden" value="{{ choice.id }}">


                    <label for="id_signal">Filter</label>
                    <input name='signal_fields' type="hidden" value="{{ choice.signal_name }}">
                    {{ choice.get_signal_name_display }}

                    {{ form.operation_fields.errors}}
                    <label for="id_name">Operation</label>
                    <select id="id_operation_fields{{ choice.id }}" name="operation_fields" onChange="operationSelect(this)" required value="{{choice.get_op_name_display}}">
                        <option value="average">average</option>
                        <option value="exceeds">count of frames with value above</option>
                        <option value="equals">count of frames with value equal to</option>
                        <option value="belows">count of frames with value below</option>
                        <option value="average_difference">average_difference</option>
                    </select>

                    <div id="secondsignal" style="display:none;">
                    {{ form.second_signal_fields.errors }}
                    <label for="id_signal2">Filter2</label>
                    {{ form.second_signal_fields }}
                    </div>

                    <div id="cutoffnumber{{ choice.id }}" style="display:none;">
                    <label for="id_cutoff ">Cutoff Number</label>
                    <input name='cutoff_number' type="text" value="{{ choice.cut_off_number }}">
                    </div>

                    <div id="display_order" style="display:none;">
                    <input name='display_order' type="hidden" value="{{ forloop.counter }}">
                    {{ form.display_order.errors }}
                    <label for="id_cutoff ">Display order</label>
                    {{ form.display_order }}
                    </div>

                    <div>

                    <label for="id_description">Description</label>
                    <input name='description' type="text" value="{{ choice.description }}">
                    </div>

                    <div>

                    <label for="id_percentage">Percentage</label>
                    <input name='percentage' type="text" value="{{ choice.percentage }}">
                    </div>

                    <div>
                    {{ form.dashboard.errors }}
                    <label for="id_percentage">Dashboard</label>
                    {{ form.dashboard }}
                    </div>
                <button type="search" class="btn btn-primary">
                    Update
                </button>
                </div>
              </form>
            </div>
            <ul>
            <p>
            <a href="delete_rule/{{choice.id}}/{{ policy.id }}"> Delete</a>
            <a class = "edit_link{{ forloop.counter }}" href="#">Edit</a>
            </p>
            </ul>
        </label>
    </p>
    {% endfor %}

    <form action="{% url 'policies:show' policy.id %}" method="post">
    {% csrf_token %}

    {% csrf_token %}
        <div id="policy_add">
                <!-- variable -->
        {{ form.signal_fields.errors }}
        <label for="id_signal">Filter</label>
        {{ form.signal_fields }}

        {{ form.operation_fields.errors}}
        <label for="id_name">Operation</label>
        {{ form.operation_fields}}



        <div id="secondsignal" style="display:none;">
        {{ form.second_signal_fields.errors }}
        <label for="id_signal2">Filter2</label>
        {{ form.second_signal_fields }}
        </div>

        <div id="cutoffnumber" style="display:none;">
        {{ form.cutoff_number.errors }}
        <label for="id_cutoff ">Cutoff Number</label>
        {{ form.cutoff_number }}
        </div>

        <div id="display_order" style="display:none;">
        {{ form.display_order.errors }}
        <label for="id_cutoff ">Display order</label>
        {{ form.display_order }}
        </div>

        <div>
         {{ form.description.errors }}
         <label for="id_description">Description</label>
         {{ form.description }}
         </div>

         <div>
         {{ form.percentage.errors }}
         <label for="id_percentage">Percentage</label>
         {{ form.percentage }}
         </div>

         <div>
         {{ form.dashboard.errors }}
         <label for="id_dashboard">Dashboard</label>
         {{ form.dashboard }}
         </div>
         <input name='display_order' type="hidden" value="{{ length }}">
         <input name='action' type="hidden" value="new">
         <button type="search" class="btn btn-primary">
                    Add
         </button>
     </div>
    </form>

    <h4> Last updated by : {{ policy.user_name}} </h4>
    <h4> Last Update : {{ policy.last_updated_time }} </h4>
    <h4> Creation time : {{policy.creation_time}} </h4>

    </div>


</div>
</div>
<script>

{% for choice in operation %}

    $("#edit_form{{ forloop.counter }}").hide();
    $(".edit_link{{ forloop.counter }}").click (function(){
        $("#edit_form{{ forloop.counter }}").show();
        document.getElementById('id_operation_fields{{ choice.id }}').value="{{choice.get_op_name_display}}";
        if ("{{choice.get_op_name_display}}" == "exceeds" ||
            "{{choice.get_op_name_display}}" == "belows" ||
            "{{choice.get_op_name_display}}" == "equals") {
            document.getElementById("cutoffnumber{{ choice.id }}").style.display = "block";
        }
    });

{% endfor %}



function operationSelect(that) {
    var parent = that.parentElement;
    var children = parent.children;
    var cutoff_element = children.cutoffnumber;
    var second_sig_element = children.secondsignal;
    if (that.value === "exceeds" || that.value === "equals" || that.value === "belows" ) {

        cutoff_element.style.display = "block";
        second_sig_element.style.display = "none";

    }
    else if (that.value == "average_difference"){
        second_sig_element.style.display = "block";
        cutoff_element.style.display = "none";
    }
    else if (that.value == "average"){
        second_sig_element.style.display = "none";
        cutoff_element.style.display = "none";
    }

}


</script>
{% endblock %}